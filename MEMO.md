| RDBMSã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | ç”¨é€” |
| ---- | ---- |
| æ§‹æ–‡è§£æ(parser) | ã‚¯ã‚¨ãƒªã‚’parseã—ã¦æŠ½è±¡æ§‹æ–‡æœ¨ã‚’æ§‹ç¯‰ |
| query plannerãƒ»å®Ÿè¡Œè¨ˆç”» | æŠ½è±¡æ§‹æ–‡æœ¨ã‚’å…ƒã«å®Ÿè¡Œè¨ˆç”»ã‚’ä½œæˆ(EXPLAINã§å‡ºåŠ›ã—ã¦ã‚‹ã®ã¯ã“ã‚Œ) |
| query executer | å®Ÿè¡Œè¨ˆç”»ã®é€šã‚Šã«ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ |
| ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¾¿ã£ã¦ã€çµæœã‚’è¿”ã™(B+Treeã¨ã‹) |
| ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ | ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®è¦æ±‚ã«å¯¾ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¸ã—å‡ºã™ |
| ãƒ‡ã‚£ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | å®Ÿéš›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®èª­ã¿æ›¸ã |

## Chapter2(Disk Manger)
- File I/Oã‚’manage
- `page`: File I/Oã®æœ€å°å˜ä½
    - 4096bytesã®æ•´æ•°å€ã§ã‚ã‚‹ã“ã¨ãŒå¤šã„
    - MySQL: 16KB
        - https://dev.mysql.com/doc/refman/8.0/ja/innodb-physical-structure.html
    - PostgreSQL: 8KB
        - https://www.postgresql.org/message-id/3c840f8b-73f0-aae7-6bcf-e22d2a0a6a40%40gusw.net
    - SQLite: 4KB
        - https://www.sqlite.org/pgszchng2016.html
    - pageã¯ã€Œãƒ–ãƒ­ãƒƒã‚¯ã€ã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§æ³¨æ„
- OSã®Fileã‚·ã‚¹ãƒ†ãƒ ã¯ãƒ–ãƒ­ãƒƒã‚¯å˜ä½ã§I/Oã‚’è¡Œã£ã¦ã„ã¦ã€ãã‚ŒãŒ4096bytesã§ã‚ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©(?)
    - https://linux.die.net/man/8/mkfs.ext4
    - RDBMSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã€pageã‚µã‚¤ã‚ºã‚’4096ã‚ˆã‚Šã‚‚å°ã•ãã—ãŸã¨ã“ã‚ã§ã€æœ€çµ‚çš„ãªOSã®File I/Oã§åˆ‡ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãã£ã¡ã«åˆã‚ã›ã‚‹ã®ãŒç„¡é›£
- Rustã ã¨ã“ã®File systemã‚’æ‰±ã£ã¦ã„ã‚‹ã®ãŒã€`std::fs`
    - ã“ã‚ŒãŒFile I/Oã®syscallã‚’ã—ã¦ãã‚Œã‚‹crate
    - ã¡ãª`std::fs::File`ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿
```rs
use std::{fs::File, io::Write};

fn main() -> std::io::Result<()> {
  let mut file = File::create("example.txt")?;
  file.write_all(b"Hello World\n")?;
  Ok(())
}
```
```sh
$ strace -e trace=open,close,read,write ./target/debug/sandbox
close(3)                                = 0
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\0\0\0\0\0\0\0\0"..., 832) = 832
close(3)                                = 0
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\220\243\2\0\0\0\0\0"..., 832) = 832
close(3)                                = 0
read(3, "636387e28000-636387e2e000 r--p 0"..., 1024) = 1024
read(3, ":01 6494                       /"..., 1024) = 1024
read(3, "77c307000 r-xp 00001000 ca:01 64"..., 1024) = 789
close(3)                                = 0
write(3, "Hello World\n", 12)           = 12
close(3)                                = 0
+++ exited with 0 +++
```

## Chapter3(BufferPool Manager)
- Disk I/Oã®é…ã•ã‚’éš è”½ã™ã‚‹ãŸã‚
  - Disk I/Oã¯ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã«æ¯”ã¹ã‚‹ã¨ã¯ã‚‹ã‹ã«é…ã„(CPUã¨ãƒ¡ãƒ¢ãƒªã‚ˆã‚Šã‚‚å¤–å´ã«å‡ºã‚‹ã‚‚ã®ã¯åŸºæœ¬é…ã„)
  - pageèª­ã¿è¾¼ã¿ã”ã¨ã«æ¯å›Disk Managerã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã¨æ€§èƒ½ãŒæ‚ªã„ãŸã‚ã€BufferPool Managerã‚’ä½¿ã£ã¦ãƒ¡ãƒ¢ãƒªä¸Šã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã“ã¨ã§é«˜é€ŸåŒ–ã™ã‚‹
- 1åº¦ç›®ã®Diskã‚¢ã‚¯ã‚»ã‚¹ã®éš›ã¯é…ã„ãŒã€2åº¦ç›®ä»¥é™ã¯ãƒ¡ãƒ¢ãƒªã¨åŒç¨‹åº¦ã®é€Ÿã•ã§èª­ã¿å‡ºã›ã‚‹
- å…¨éƒ¨ãƒ¡ãƒ¢ãƒªä¸Šã«ä¹—ã›ã‚‰ã‚Œã‚‹ã¯ãšã‚‚ãªã„ã®ã§ã€ç‰¹å®šã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ã£ã¦ã©ã®ãƒšãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã€ã©ã®ãƒšãƒ¼ã‚¸ã‚’æ¨ã¦ã‚‹ã®ã‹ã‚’æ±ºå®šã™ã‚‹
  - -> Clock-sweep

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2024-08-17 13 01 43](https://github.com/user-attachments/assets/9ff5bd7c-aa95-40f4-8ce7-f8434b0932fb)

## Chapter4(ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰(B+Tree))
- B-Tree
  - https://github.com/tsuzuki-takaaki/brain/tree/main/DB/btree
- B+Tree
  - è©³ã—ãã¯: https://github.com/tsuzuki-takaaki/brain/tree/main/DB/btree
  - `Leaf node`: key-valueã®ãƒšã‚¢ã‚’æŒã¤(å®Ÿãƒ‡ãƒ¼ã‚¿)
    - keyã§sortã•ã‚Œã¦ã„ã‚‹ -> Leaf nodeã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ã¯å…¨ã¦ã®Leaf nodeã‚’é€šã—ã¦ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸé †åºã§ä¸¦ã‚“ã§ã„ã‚‹
    - -> å³ã®Leaf nodeã«å·¦ã®Leaf nodeã‚ˆã‚Šå°ã•ã„ã‚­ãƒ¼ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ãªã„
  - `Internal node(ä¸­é–“ãƒãƒ¼ãƒ‰)`: valueã‚’æŒãŸãªã„, ã‚­ãƒ¼ã®å€‹æ•°ã‚ˆã‚Š1ã¤å¤šã„å€‹æ•°ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã¤, ä¸­é–“ãƒãƒ¼ãƒ‰ã«å«ã¾ã‚Œã‚‹keyã¯ã€Œåˆ†å‰²ã‚­ãƒ¼ã€ã¨å‘¼ã°ã‚Œã‚‹
- æ¤œç´¢ã®æµã‚Œ
  - å¯¾è±¡ã®keyã‚’è¦‹ã¤ã‘ã‚‹ã¾ã§ä¸­é–“ãƒãƒ¼ãƒ‰ã‚’è¾¿ã‚‹
  - keyã¯sortã•ã‚Œã¦ã„ã‚‹ãŸã‚äºŒåˆ†æ¢ç´¢ã§ãã‚‹
  - å¯¾è±¡ã®keyãŒå«ã¾ã‚Œã‚‹Leaf node(Page)ã«åˆ°é”ã—ãŸã‚‰Leaf nodeå†…ã‚’äºŒåˆ†æ¢ç´¢ã™ã‚‹
- Insertã®æµã‚Œ
  - åŒæ§˜ã«ã€å¯¾è±¡ã®key-valueãŒæŒ¿å…¥ã•ã‚Œã‚‹ã¹ãLeaf nodeã‚’æ¢ç´¢ã™ã‚‹
  - è¦‹ã¤ã‹ã£ãŸLeaf node(Page)ã«ä½™è£•ãŒã‚ã£ãŸå ´åˆã€ãã®ã¾ã¾insertã™ã‚‹
  - ä½™è£•ãŒãªã‹ã£ãŸå ´åˆã¯ã€ã€Œãƒãƒ¼ãƒ‰åˆ†å‰²ã€
- ãƒãƒ¼ãƒ‰åˆ†å‰²
  - ç©ºã®ãƒãƒ¼ãƒ‰ã‚’å¤ã„ãƒãƒ¼ãƒ‰ã®å·¦å´ã«ä½œã‚Šã€å¤ã„ãƒãƒ¼ãƒ‰ã®å†…å®¹ã®åŠåˆ†ã‚’æ–°ã—ã„ãƒãƒ¼ãƒ‰ã«ç§»ã™
  - ç§»ã—ã¦ç©ºã„ãŸé ˜åŸŸã«æ›¸ãè¾¼ã¿
  - å¤ã„ãƒãƒ¼ãƒ‰ã®æœ€å°å€¤ã‚’è¦ªã®internal nodeã®æ–°ã—ã„åˆ†å‰²ã‚­ãƒ¼ã«ã™ã‚‹(ãƒã‚¤ãƒ³ã‚¿ã§è¾¿ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹)
- B+Treeã‚’å®Ÿè£…ã™ã‚‹ã¨ãªã‚‹ã¨ã€ã‹ãªã‚Šæ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€ä½¿ã„æ–¹ã¨ç‰¹æ€§ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã€B+Treeã‚’**ä½¿ã†**ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦å‹•ã‹ã—ãªãŒã‚‰ç†è§£ã‚’é€²ã‚ã‚‹

## Chapter5(ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®Ÿè£…)
- Clustered index
  - ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªä½“ã‚’B+Treeã«æ ¼ç´ã—ã¦ã—ã¾ã†æ‰‹æ³•
  - -> DBãã‚Œè‡ªä½“ãŒB+Treeã§ã§ãã¦ã„ã‚‹
  - InnoDBã¨ã‹ã¯ã“ã‚Œ
- Secondary index
  - ã€Œindexã‚’ä½œã‚‹ãƒ»å¼µã‚‹ã€ã®æ–‡è„ˆã§ä½¿ã‚ã‚Œã¦ã„ã‚‹indexã¯Secondary indexã®ã“ã¨
- `ãƒ†ãƒ¼ãƒ–ãƒ«`: è¡Œã¨åˆ—ã‹ã‚‰ãªã‚‹ã‚‚ã®
- `B+Tree`: key-valueãƒ‡ãƒ¼ã‚¿æ ¼ç´ã«å„ªã‚Œã„ã¦ã„ã‚‹ã‚‚ã®
- â†‘ ã®2ã¤ã‚’ã©ã†ã‚„ã£ã¦çµ±åˆã™ã‚‹ã‹ï¼Ÿ
  - primary keyã¨ãã‚Œä»¥å¤–ã«åˆ†ã‘ã‚‹
ex(image)
```ruby
a = {id: 1, name: "hello", age: 30}
b = {id: 2, name: "world", age: 20}

â†“

a = {key: 1, value: ["hello", 30]}
b = {key: 2, value: ["world", 20]}
```
- schema
  - å„åˆ—ã®åå‰ãƒ»å‹ã‚„ã©ã®åˆ—ãŒãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚­ãƒ¼ãªã®ã‹ãªã©ã€`CREATE TABLE`æ–‡ã§æŒ‡å®šã™ã‚‹ã‚ˆã†ãªå†…å®¹ã®ã“ã¨
- ä»Šå›ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ã¯å¯å¤‰é•·ã®ãƒã‚¤ãƒˆåˆ—ã ã‘
  - ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚­ãƒ¼ã¯å·¦ã«å¯„ã›ã‚‹ã“ã¨ã§çµ±ä¸€ã™ã‚‹

### ğŸ«›
- flush
  - [File#flush](https://doc.rust-lang.org/std/fs/struct.File.html#method.flush)
    - > Flushes the file, ensuring that all intermediately buffered contents reach their destination.
    - bufferingçŠ¶æ…‹ã§æ­¢ã¾ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’disk writeã™ã‚‹
